{% extends 'base.html' %}
{% from "partials/_auth_info_block.html" import render_info_sections with context %}

{% block title %}LightBox - Register{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8 col-xl-7">
        <div class="card shadow mb-4">
            <div class="card-header bg-white text-center">
                <h1 class="card-title mb-0 h4">Create Your LightBox Account</h1>
            </div>
            <div class="card-body p-lg-4">
                <div class="row">
                    <div class="col-md-6 mb-4 mb-md-0">
                        <form method="post" id="registerForm" novalidate> {# Added novalidate to allow our JS to fully control validation feedback #}
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" name="username" required minlength="3" autocomplete="username">
                                <div class="invalid-feedback">Please choose a username (minimum 3 characters).</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" name="password" required minlength="6" autocomplete="new-password">
                                <div class="form-text small">Minimum 6 characters.</div>
                                <div class="invalid-feedback">Password must be at least 6 characters.</div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="confirm_password" class="form-label">Confirm Password</label>
                                <input type="password" class="form-control" id="confirm_password" name="confirm_password" required minlength="6" autocomplete="new-password">
                                <div class="invalid-feedback" id="confirmPasswordError">Passwords do not match.</div> {# Changed to Bootstrap invalid-feedback #}
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">Register</button>
                        </form>
                        <div class="mt-3 text-center">
                            <p class="small">Already have an account? <a href="{{ url_for('login') }}">Login here</a></p>
                        </div>
                    </div>
                    <div class="col-md-6 border-md-start ps-md-4">
                        {{ render_info_sections(show_welcome=true, show_getting_started=true, show_mkv_note=true, show_copyright_warning=true, show_contact=false) }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm_password');
        const confirmPasswordErrorDiv = document.getElementById('confirmPasswordError'); // The div for feedback

        function validatePasswordsMatch() {
            if (passwordInput.value !== confirmPasswordInput.value) {
                confirmPasswordInput.classList.add('is-invalid');
                confirmPasswordErrorDiv.textContent = 'Passwords do not match.'; // Set text if needed, Bootstrap handles display
                return false;
            } else {
                confirmPasswordInput.classList.remove('is-invalid');
                // confirmPasswordErrorDiv.textContent = ''; // Clear text, Bootstrap handles hiding
                return true;
            }
        }

        // Validate on input for immediate feedback
        if (confirmPasswordInput) {
            confirmPasswordInput.addEventListener('input', validatePasswordsMatch);
        }
        if (passwordInput) {
            passwordInput.addEventListener('input', function() {
                // If confirm password has been touched and filled, re-validate
                if (confirmPasswordInput.value !== '') {
                    validatePasswordsMatch();
                }
            });
        }

        registerForm.addEventListener('submit', function(e) {
            let formIsValid = true;

            // Bootstrap 5 client-side validation (simple check for 'required' and 'minlength')
            // For more complex patterns, you'd add more JS or rely on server-side.
            Array.from(registerForm.elements).forEach(function(element) {
                if (element.hasAttribute('required') && !element.value) {
                    element.classList.add('is-invalid');
                    formIsValid = false;
                } else if (element.hasAttribute('minlength') && element.value.length < parseInt(element.getAttribute('minlength'))) {
                    element.classList.add('is-invalid');
                     // Get the invalid-feedback sibling to show a specific message if desired
                    const feedback = element.parentElement.querySelector('.invalid-feedback');
                    if(feedback && element.id === 'username') feedback.textContent = `Username must be at least ${element.getAttribute('minlength')} characters.`;
                    if(feedback && element.id === 'password') feedback.textContent = `Password must be at least ${element.getAttribute('minlength')} characters.`;
                    formIsValid = false;
                } else {
                    element.classList.remove('is-invalid');
                }
            });

            if (!validatePasswordsMatch()) {
                formIsValid = false;
            }
            
            if (!formIsValid) {
                e.preventDefault();
                e.stopPropagation(); // Stop Bootstrap's own submit handling if we found errors
                // Find first invalid input and focus it
                const firstInvalid = registerForm.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.focus();
                }
            }
            // registerForm.classList.add('was-validated'); // Optional: if you want Bootstrap's default styling after first submit attempt
        });

        // Clear validation on input change after initial submit attempt or error
        Array.from(registerForm.elements).forEach(function(element) {
            element.addEventListener('input', function() {
                if (this.classList.contains('is-invalid')) {
                    this.classList.remove('is-invalid');
                }
            });
        });
    }
});
</script>
{% endblock %}
